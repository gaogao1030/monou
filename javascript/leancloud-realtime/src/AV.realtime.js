void function(e){var t="2.1.0",n=e.AV||{};e.AV=n,"function"==typeof define&&define.amd&&define("AV",[],function(){return n});var i={heartbeatsTime:6e4},o={},r={},a={open:"open",reuse:"reuse",close:"close",create:"create",join:"join",left:"left",message:"message",receipt:"receipt",update:"update",error:"error"},s=function(e){var t=function(t,n,i,o){var a,s,c,d=[];switch("string"==typeof n?d.push(n):d=n,a={cid:t,members:d,serialId:r.getSerialId()},o){case"add":c="conv-added",r.convAdd(a);break;case"remove":c="conv-removed",r.convRemove(a)}return s=function(t){t.i===a.serialId&&(i&&i(t),e.ec.off(c,s))},e.ec.on(c,s),this};return{id:"",attr:{},add:function(e,n){return t(this.id,e,n,"add"),this},remove:function(e,n){return t(this.id,e,n,"remove"),this},join:function(t){return this.add(e.options.peerId,t),this},leave:function(t){return this.remove(e.options.peerId,t),this},send:function(t,n,i){var o,a={},s=this;switch(arguments.length){case 2:o=n;break;case 3:a=n,o=i}if(a.cid=s.id,a.serialId=r.getSerialId(),a.data=a.type?r.setMediaMsg(a.type,t):"string"==typeof t?t:JSON.stringify(t),a.receipt&&(a.receipt=1),!a["transient"]){var c=function(t){t.i===a.serialId&&(o&&o(t),e.ec.off("ack",c))};e.ec.on("ack",c)}return r.send(a,o),this},log:function(t,n){var i={};switch(arguments.length){case 1:n=t;break;case 2:i=t}i.cid=i.cid||this.id,i.serialId=i.serialId||r.getSerialId();var o=function(t){if(t.i===i.serialId){if(n){for(var a=0,s=t.logs.length;s>a;a++)t.logs[a].data=r.getMediaMsg(t.logs[a].data),t.logs[a].fromPeerId=t.logs[a].from,t.logs[a].msg=t.logs[a].data;n(t.logs)}e.ec.off("logs",o)}};return e.ec.on("logs",o),r.convLog(i),this},receive:function(t){var n=this.id;return e.ec.on(a.message,function(e){n===e.cid&&t(e)}),this},receipt:function(t){var n=this.id;return e.ec.on(a.receipt,function(e){n===e.cid&&t(e)}),this},list:function(t){var n={},i=this.id;n.where={m:e.options.peerId,objectId:i},n.serialId=r.getSerialId();var o=function(i){i.i===n.serialId&&(t&&t(i.results.length?i.results[0].m:[]),e.ec.off("conv-results",o))};return e.ec.on("conv-results",o),r.convQuery(n),this},count:function(t){var n=this.id,i={cid:n,serialId:r.getSerialId()},o=function(n){n.i===i.serialId&&(t&&t(n.count),e.ec.off("conv-result",o))};return e.ec.on("conv-result",o),r.convCount(i),this},update:function(t,n){var i=this.id,o={cid:i,data:t,serialId:r.getSerialId()},a=function(t){t.i===o.serialId&&(n&&n(t),e.ec.off("conv-updated",a))};return e.ec.on("conv-updated",a),r.convUpdate(o),this}}},c=function(){var n={options:void 0,ws:void 0,ec:void 0,openFlag:!1,closeFlag:!1,reuseTimer:void 0,resuseFlag:!1,serialId:2015},c=function(){r.bindEvent(),r.openSession({serialId:r.getSerialId()}),r.heartbeats(),r.guard()},d=function(e){n.ec.emit(a.close,e)},u=function(e){var t=JSON.parse(e.data);if(t.cmd){var i=t.cmd;t.op&&(i+="-"+t.op),n.ec.emit(i,t)}},l=function(e){throw n.ec.emit(a.error,e),e},p=function(e){if(!n.closeFlag){if(!n.ws)throw'The realtimeObject must opened first. Please listening to the "open" event.';n.ws.send(JSON.stringify(e))}};return r.createSocket=function(e){n.ws&&n.ws.close();var t=new WebSocket(e);n.ws=t,t.addEventListener("open",c),t.addEventListener("close",d),t.addEventListener("message",u),t.addEventListener("error",l)},r.heartbeats=function(){var e;n.ws.addEventListener("message",function(){e&&clearTimeout(e),e=setTimeout(function(){p({})},i.heartbeatsTime)}),r.heartbeats=o.noop},r.guard=function(){var e,t=18e4;n.ws.addEventListener("message",function(){e&&clearTimeout(e),e=setTimeout(function(){n.closeFlag||n.resuseFlag||(n.resuseFlag=!0,n.ec.emit(a.reuse))},t)}),n.ec.on(a.close+" session-closed",function(){n.closeFlag||n.resuseFlag||(n.resuseFlag=!0,n.ec.emit(a.reuse))}),r.guard=o.noop},r.connect=function(e){var t=e.server;if(!(t&&o.now()<t.expires))throw"WebSocket connet failed.";r.createSocket(t.server)},r.getServer=function(t,i){var r=t.appId,s=t.secure,c="",d="http://";e&&"https:"===e.location.protocol&&s&&(d="https://"),c=d+"router-g0-push.avoscloud.com/v1/route?_t="+o.now()+"&appId="+r,s&&(c+="&secure=1"),o.ajax({url:c,form:!0},function(e,t){if(e)e.expires=o.now()+1e3*e.ttl,n.server=e,i(e);else{if(403===t.code||404===t.code)throw t.error;n.ec.emit(a.error)}})},r.openSession=function(e){var i={cmd:"session",op:"open",appId:n.options.appId,peerId:n.options.peerId,ua:"js/"+t,i:e.serialId};n.authFun?n.authFun({clientId:n.options.peerId},function(e){if(!e||!e.signature)throw"Session open denied by application: "+e;i.n=e.nonce,i.t=e.timestamp,i.s=e.signature,p(i)}):p(i)},r.closeSession=function(){p({cmd:"session",op:"close",peerId:n.options.peerId})},r.startConv=function(e){var t={cmd:"conv",op:"start",m:e.members,appId:n.options.appId,peerId:n.options.peerId,attr:{name:e.name||"",attr:e.attr||{}},i:e.serialId,"transient":e["transient"]||!1};n.authFun?n.authFun({clientId:n.options.peerId,members:e.members},function(e){if(!e||!e.signature)throw"Conversation creation denied by application: "+e;t.n=e.nonce,t.t=e.timestamp,t.s=e.signature,p(t)}):p(t)},r.convAdd=function(e){var t={cmd:"conv",op:"add",cid:e.cid,m:e.members,appId:n.options.appId,peerId:n.options.peerId,i:e.serialId};n.authFun?n.authFun({clientId:n.options.peerId,members:e.members,convId:e.cid,action:"invite"},function(e){if(!e||!e.signature)throw"Adding members to conversation denied by application: "+e;t.n=e.nonce,t.t=e.timestamp,t.s=e.signature,p(t)}):p(t)},r.convRemove=function(e){var t={cmd:"conv",op:"remove",cid:e.cid,m:e.members,appId:n.options.appId,peerId:n.options.peerId,i:e.serialId};n.authFun&&(e.members.length>1||e.members[0]!=n.options.peerId)?n.authFun({clientId:n.options.peerId,members:e.members,convId:e.cid,action:"kick"},function(e){if(!e||!e.signature)throw"Removing members from conversation denied by application: "+e;t.n=e.nonce,t.t=e.timestamp,t.s=e.signature,p(t)}):p(t)},r.send=function(e){p({cmd:"direct",cid:e.cid,appId:n.options.appId,peerId:n.options.peerId,msg:e.data,i:e.serialId,r:e.receipt||!1,"transient":e["transient"]||!1})},r.convQuery=function(e){e=e||{},p({cmd:"conv",op:"query",appId:n.options.appId,peerId:n.options.peerId,where:e.where||{m:n.options.peerId},sort:e.sort||"-lm",limit:e.limit||10,skip:e.skip||0,i:e.serialId})},r.querySession=function(e){p({cmd:"session",op:"query",appId:n.options.appId,peerId:n.options.peerId,i:e.serialId,sessionPeerIds:e.peerIdList})},r.convLog=function(e){p({cmd:"logs",cid:e.cid,t:e.t||void 0,mid:e.mid||void 0,limit:e.limit||20,appId:n.options.appId,peerId:n.options.peerId,i:e.serialId})},r.convUpdate=function(e){p({cmd:"conv",op:"update",appId:n.options.appId,peerId:n.options.peerId,cid:e.cid,attr:e.data,i:e.serialId})},r.convAck=function(e){p({cmd:"ack",cid:e.cid,appId:n.options.appId,peerId:n.options.peerId,mid:e.mid})},r.convCount=function(e){p({cmd:"conv",op:"count",appId:n.options.appId,peerId:n.options.peerId,i:e.serialId,cid:e.cid})},r.getMediaMsg=function(e){if(!o.isJSONString(e))return n.options.encodeHTML&&(e=o.encodeHTML(e)),e;if(e=JSON.parse(e),!e.hasOwnProperty("_lctype"))return e;var t={text:e._lctext,attr:e._lcattrs};switch(n.options.encodeHTML&&(t.text=o.encodeHTML(e._lctext)),e._lcfile&&e._lcfile.url&&(t.url=e._lcfile.url),e._lcfile&&e._lcfile.metaData&&(t.metaData=e._lcfile.metaData),e._lctype){case-1:t.type="text";break;case-2:t.type="image";break;case-3:t.type="audio";break;case-4:t.type="video";break;case-5:t.type="location";break;case-6:t.type="file"}return t},r.setMediaMsg=function(e,t){var n;if("text"!==e&&!t.metaData)throw"Media Data must have metaData attribute.";switch(e){case"text":n={_lctype:-1,_lctext:t.text,_lcattrs:t.attr};break;case"image":n={_lctype:-2,_lctext:t.text,_lcattrs:t.attr,_lcfile:{url:t.url,objId:t.objectId,metaData:{name:t.metaData.name,format:t.metaData.format,height:t.metaData.height,width:t.metaData.width,size:t.metaData.size}}};break;case"audio":n={_lctype:-3,_lctext:t.text,_lcattrs:t.attr,_lcfile:{url:t.url,objId:t.objectId,metaData:{name:t.metaData.name,format:t.metaData.format,duration:t.metaData.duration,size:t.metaData.size}}};break;case"video":n={_lctype:-4,_lctext:t.text,_lcattrs:t.attr,_lcfile:{url:t.url,objId:t.objectId,metaData:{name:t.metaData.name,format:t.metaData.format,duration:t.metaData.duration,size:t.metaData.size}}};break;case"location":n={_lctype:-5,_lctext:t.text,_lcattrs:t.attr,_lcloc:{longitude:t.metaData.longitude,latitude:t.metaData.latitude}};break;case"file":n={_lctype:-6,_lctext:t.text,_lcattrs:t.attr,_lcfile:{name:t.metaData.name,size:t.metaData.size}}}return n=JSON.stringify(n)},r.getSerialId=function(){return n.serialId++,n.serialId>999999&&(n.serialId=2015),n.serialId},r.bindEvent=function(){n.ec.on("session-opened",function(e){n.resuseFlag=!1,n.openFlag=!0,n.ec.emit(a.open,e)}),n.ec.on("session-error",function(e){n.ec.emit(a.error,e)}),n.ec.on("conv-joined",function(e){e.peerId!==e.initBy&&n.ec.emit(a.join,e)}),n.ec.on("conv-left",function(e){n.ec.emit(a.left,e)}),n.ec.on("conv-members-joined",function(e){n.ec.emit(a.join,e)}),n.ec.on("conv-members-left",function(e){n.ec.emit(a.left,e)}),n.ec.on("conv-error",function(e){throw n.ec.emit(a.error,e),e.code+":"+e.reason}),n.ec.on("direct",function(e){e.msg=r.getMediaMsg(e.msg),r.convAck({cid:e.cid,mid:e.id}),n.ec.emit(a.message,e)}),n.ec.on("rcp",function(e){n.ec.emit(a.receipt,e)}),r.bindEvent=o.noop},{cache:n,open:function(e){var t=this;return n.closeFlag=!1,r.getServer(n.options,function(e){e&&r.connect({server:n.server})}),e&&n.ec.once(a.open,e),n.ec.once(a.reuse,function(){n.reuseTimer&&clearTimeout(n.reuseTimer),n.reuseTimer=setTimeout(function(){t.open()},5e3)}),this},close:function(){if(!n.openFlag)throw"Must call after open() has successed.";return n.closeFlag=!0,r.closeSession(),n.ws.close(),this},on:function(e,t){return this.cache.ec.on(e,t),this},once:function(e,t){return this.cache.ec.once(e,t),this},emit:function(e,t){return this.cache.ec.emit(e,t),this},off:function(e,t){return this.cache.ec.off(e,t),this},room:function(e,t){if(!n.openFlag)throw"Must call after open() has successed.";var i=s(n);if("string"==typeof e)this.query({where:{objectId:e}},function(n){n.length&&(i.id=e,i.name=n[0].name,i.attr=n[0].attr),t&&t(n.length?i:null)});else{if(!e)throw"Createing room must have a callback function.";var o;"function"==typeof e?t=e:o=e,o={name:o.name||"",members:o.members||[],attr:o.attr||{},"transient":o["transient"]||!1,serialId:r.getSerialId()},r.startConv(o,t);var c=function(e){e.i===o.serialId&&(i.id=e.cid,i.name=o.name,i.attr=o.attr,t&&t(i),n.ec.emit(a.create,e),n.ec.off("conv-started",c))};n.ec.on("conv-started",c)}return i},conv:function(e,t){return this.room(e,t)},query:function(e,t){if(!n.openFlag)throw"Must call after open() has successed.";var i={};switch(arguments.length){case 1:t=e;break;case 2:i=e}i.serialId=r.getSerialId();var o=function(e){e.i===i.serialId&&(t&&t(e.results),n.ec.off("conv-results",o))};return n.ec.on("conv-results",o),r.convQuery(i),this},ping:function(e,t){if(!n.openFlag)throw"Must call after open() has successed.";if(!t)throw"Ping must have callback.";var i=[];"string"==typeof e?i.push(e):i=e;var o={serialId:r.getSerialId(),peerIdList:i},a=function(e){e.i===o.serialId&&(t(e.onlineSessionPeerIds),n.ec.off("session-query-result",a))};return n.ec.on("session-query-result",a),r.querySession(o),this}}};n.realtime=function(t,n){if("object"!=typeof t)throw"AV.realtime need a argument at least.";if(!t.appId)throw"Options must have appId.";if(e.WebSocket){var i=e.WebSocket.loadFlashPolicyFile?!1:!0;t={appId:t.appId,peerId:t.clientId,encodeHTML:t.encodeHTML||!1,auth:t.auth,secure:"undefined"==typeof t.secure?i:t.secure};var r=c();return r.cache.options=t,r.cache.ec=o.eventCenter(),r.cache.authFun=t.auth,r.open(n),r}alert("Bowser must support WebSocket, please read LeanCloud doc and use plugin.")},n.realtime.version=t,n.realtime._tool=o,n.realtime._engine=r,o.noop=function(){},o.getId=function(){var e=function(){return(new Date).getTime().toString(36)+Math.random().toString(36).substring(2,3)};return"AV"+e()},o.isJSONString=function(e){return/^\{.*\}$/.test(e)},o.ajax=function(e,t){var n,i=e.url,o=e.method||"get";n=window.XDomainRequest?new XDomainRequest:new XMLHttpRequest,n.open(o,i),"post"===o&&(e.form?n.setRequestHeader("Content-Type","application/x-www-form-urlencoded"):(n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("Access-Control-Allow-Origin","*"),n.setRequestHeader("Access-Control-Allow-Headers","Origin, X-Requested-With, Content-Type, Accept"),n.setRequestHeader("Access-Control-Allow-Methods","POST, GET, OPTIONS, DELETE, PUT, HEAD"))),n.onload=function(e){n.status>=200&&n.status<300||window.XDomainRequest&&!n.status?t(JSON.parse(n.responseText)):t(null,JSON.parse(n.responseText))},n.onerror=function(e){throw t(null,e||{}),"Network error."},n.onprogress=function(){},n.ontimeout=function(){},n.timeout=0;var r="";if(e.form)for(var a in e.data)r+=r?"&"+a+"="+e.data[a]:a+"="+e.data[a];else r=JSON.stringify(e.data);n.send(r)},o.now=function(){return(new Date).getTime()},o.encodeHTML=function(e){var t=function(e){return"string"==typeof e?e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"):e};if("object"==typeof e){for(var n in e)e[n]=o.encodeHTML(e[n]);return e}return t(e)},o.eventCenter=function(){function e(e){var t=[],n=0,i=e.length;if(i){for(;i>n;n++)e[n]&&t.push(e[n]);return t}return null}var t={},n={},i=function(e,i,o){if(!e)throw"No event name.";if(!i)throw"No callback function.";var r,a=e.split(/\s+/);r=o?n:t;for(var s=0,c=a.length;c>s;s++)a[s]&&(r[a[s]]||(r[a[s]]=[]),r[a[s]].push(i))},o=function(e,i,o){var r;if(r=o?n:t,r[e])for(var a=0,s=r[e].length;s>a;a++)if(r[e][a]===i)return void(r[e][a]=null)};return{on:function(e,t){return i(e,t),this},once:function(e,t){return i(e,t,!0),this},emit:function(i,r){if(!i)throw"No emit event name.";var a=0,s=0;if(t[i]){for(a=0,s=t[i].length;s>a;a++)t[i][a]&&t[i][a].call(this,r);t[i]=e(t[i])}if(n[i]){for(a=0,s=n[i].length;s>a;a++)n[i][a]&&(n[i][a].call(this,r),o(i,n[i][a],!0));n[i]=e(n[i])}return this},off:function(e,t){return o(e,t),this}}}}(window);