var app_id,authFun,bindEvent,cleart_members,click_member,clientIdToMember,close_connect,connect,elements,encodeHTML,formatTime,getLog,get_conversation,get_element,get_member,get_online_members,main,members,msgTime,originClientId,pressEnter,rerender_members_list,roomname,secret_key,sendMsg,showLog,showMsg,start,timeoutPromise;elements={},app_id=void 0,secret_key=void 0,msgTime=void 0,roomname="teaParty-demo",this.chat_demo={},members=[{clientId:"leancloud",name:"leancloud"},{clientId:"1",name:"爱丽丝"},{clientId:"2",name:"亚瑟王"},{clientId:"3",name:"特斯拉"},{clientId:"4",name:"爱因斯坦"},{clientId:"5",name:"绅士君"},{clientId:"6",name:"超人"},{clientId:"7",name:"变态君"},{clientId:"8",name:"咖啡君"},{clientId:"9",name:"多啦A梦"},{clientId:"10",name:"金闪闪"}],start=function(e,n){return AV.initialize(e,n),roomname="teaParty-demo",app_id=e,n=n,get_element(),get_conversation().then(function(e){return connect(roomname,e,"leancloud").then(function(n,t){return get_member(n,t).then(function(t){return close_connect(n).then(function(){return void 0!==t?main(roomname,e,t):showLog("该茶会人已经满了,请过会来")})})})},function(e){return console.log("Error: "+error.code+" "+error.message)})},connect=function(e,n,t){var r,o;return o=AV.realtime({appId:app_id,clientId:e+":"+t,secure:!1,auth:authFun}),r=new AV.Promise,o.on("open",function(){return o.room(n,function(t){return t?r.resolve(o,t):o.room({name:e,attr:{room_id:e},members:[e+":leancloud"]},function(e){return n=e.id,close_connect(o).then(function(){return r.resolve(o,e)})})})}),r},close_connect=function(e){var n;return n=new AV.Promise,e.close(),e.on("close",function(){return n.resolve()}),n},get_element=function(){return elements.body=$("body"),elements.printWall=$("#print_wall"),elements.sendMsgBtn=$("#basic-addon2"),elements.vister_list=$("#vister_list"),elements.inputSend=$("#input_send")},get_conversation=function(){var e,n,t;return n=new AV.Promise,e=AV.Object.extend("_conversation"),t=new AV.Query(e),t.equalTo("attr.room_id",roomname),t.find({success:function(e){var t,r;return t=(null!=(r=e[0])?r.id:void 0)||"null",n.resolve(t)},error:function(){return n.reject(err)}}),n},bindEvent=function(e,n){return elements=elements,elements.body.on("keydown",function(e){return pressEnter(e,n)}),elements.sendMsgBtn.on("click",function(){return sendMsg(n)}),$(document).on("click",".member",click_member)},click_member=function(e){return alert($(this).html())},rerender_members_list=function(e,n,t){var r,o,i;return i=elements.vister_list,i.html(""),r=function(){o=[];for(var e=0,n=parseInt(t.length/20);n>=0?n>=e:e>=n;n>=0?e++:e--)o.push(e);return o}.apply(this),_.each(r,function(r){var o;return o=t.slice(20*r,20*(r+1)),e.ping(o,function(e){return _.each(e,function(e){var t,r,o;return e=originClientId(e),t=clientIdToMember(e),r=t.name,e===n&&(r=t.name+"(我)"),o='<a href="javascript:void(0)"><div class="member" >'+r+"</div></a>",i.append(o)})}),t.length>50?room.remove(t[1],function(){return showLog("人数过多驱逐出去的是",t[1])}):void 0})},showLog=function(e,n,t){var r,o;return n&&(e=e+'<span class="strong">'+encodeHTML(JSON.stringify(n))+"</span>"),o=$("#print_wall")[0],r=document.createElement("p"),r.innerHTML=e,t?o.insertBefore(r,o.childNodes[0]):o.appendChild(r)},pressEnter=function(e,n){return 13===e.keyCode?sendMsg(n):void 0},authFun=function(e,n){return AV.realtime._tool.ajax({url:"https://gaogao.avosapps.com/sign2",data:{client_id:e.clientId,conv_id:e.convId,members:e.members,action:e.action},method:"post"},n)},encodeHTML=function(e){return String(e).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},sendMsg=function(e){var n,t,r;return elements=elements,n=elements.inputSend,r=elements.printWall[0],t=n.val(),String(t).replace(/^\s+/,"").replace(/\s+$/,"")?e.send({text:t},{type:"text"},function(e){return n.val(""),showLog("（"+formatTime(e.t)+"）  自己： ",t),r.scrollTop=r.scrollHeight}):void alert("请输入点文字！")},getLog=function(e){var n,t,r,o;return o=new AV.Promise,elements=elements,r=elements.printWall[0],n=r.scrollHeight,t?void 0:(t=!0,e.log({t:msgTime},function(e){var i;return t=!1,i=e.length,i&&(msgTime=e[0].timestamp,r.scrollTop=r.scrollHeight-n,e.reverse()),_.each(e,function(e){return showMsg(e,!0)}),o.resolve()}),o)},showMsg=function(e,n,t){var r,o,i,c;return c="",r=e.fromPeerId,o=null!=(i=clientIdToMember(originClientId(r)))?i.name:void 0,c=e.msg.type?e.msg.text:e.msg,e.fromPeerId===t&&(o="自己"),String(c).replace(/^\s+/,"").replace(/\s+$/,"")?showLog("（"+formatTime(e.timestamp)+"）  "+encodeHTML(o)+"： ",c,n):void 0},formatTime=function(e){var n;return n=new Date(e),$.format.date(n,"yyyy-MM-dd hh:mm:ss")},main=function(e,n,t){var r;return r=elements.printWall,showLog("正在加入轻飘飘的下午茶时间，请等待。。。"),connect(e,n,t).then(function(e,n){return bindEvent(e,n),showLog("欢迎来到轻飘飘的下午茶时间"),n.join(function(){return getLog(n).then(function(){return r[0].scrollTop=r[0].scrollHeight,showLog("已经加入，可以开始聊天。")})}),n.receive(function(e){return r[0].scrollTop=r[0].scrollHeight,msgTime||(msgTime=e.timestamp),showMsg(e)}),e.on("reuse",function(){return showLog("正在重新加入轻飘漂的下午茶时间")}),e.on("error",function(){return showLog("好像有什么不对劲 请打开console 查看相关日志 "),console.log(e)}),e.on("join",function(r){return _.each(r.m,function(r){var o;return r!==t?(o=clientIdToMember(originClientId(r)),showLog(o.name+"加入下午茶"),n.list(function(n){return rerender_members_list(e,t,n)})):void 0})}),e.on("left",function(e){return console.log(e)})})},cleart_members=function(){return room.list(function(e){return room.remove(e,function(){return console.log("clear_members")})})},get_online_members=function(e,n,t){var r,o;return null==t&&(t={}),r=[],o=new AV.Promise,n.list(function(n){var t,i;return t=function(){i=[];for(var e=0,t=parseInt(n.length/20);t>=0?t>=e:e>=t;t>=0?e++:e--)i.push(e);return i}.apply(this),_.each(t,function(t){var i;return i=n.slice(20*t,20*(t+1)),e.ping(i,function(e){return _.each(e,function(e){return r.push(e)}),o.resolve(r)})})}),timeoutPromise(o,1e4)},originClientId=function(e){return void 0!==e&&null!==e.match(roomname)?e.slice(roomname.length+1):void 0},clientIdToMember=function(e){var n;return n=_.findWhere(members,{clientId:e})},get_member=function(e,n){var t;return t=new AV.Promise,get_online_members(e,n).then(function(e){var n,r,o,i;return o=e.map(function(e){return originClientId(e)}),n=_.clone(members),_.each(o,function(e){var t;return t=clientIdToMember(e),n=_.without(n,t)}),r=null!=(i=n[0])?i.clientId:void 0,t.resolve(r)}),t},timeoutPromise=function(e,n){var t,r;return t=function(){return new AV.Promise(function(e){return setTimeout(e,n)})},r=t(n).then(function(){return Promise.reject(new Error("请求超时"))}),AV.Promise.race([e,r])},this.chat_demo.get_member=function(){return get_conversation().then(function(e){return connect("teaParty-demo",e,"leancloud").then(function(e,n){return get_member(e,n).then(function(n){return console.log(n),close_connect(e)})})})},this.chat_demo.get_online_members=function(){return get_conversation().then(function(e){return connect("teaParty-demo",e,"leancloud").then(function(e,n){return get_online_members(e,n).then(function(n){return console.log(n),close_connect(e)})})})},this.chat_demo.get_conversation=get_conversation,this.chat_demo.start=start,this.chat_demo.clear_members=cleart_members;